---
title: "Lachat NO3, NH3 PO3"
author: "mdusaire"
date: "Thursday, August 27, 2015"
output: html_document
---

This is a parser for correcting drift in Lachat NO3, NH3 and PO3 analyses.  It fits curve to the high calibration and check standards versus run position, then correct sample and check standard concentrations based on the fractional difference (usually a decrease) between the expected value and the measured area for the standard.

For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
# Get list of object in the current Global Environment and make copies of any object that matches an object used in the LachatDriftCorrection.R

initial.env <- ls()

# Load libraries

library(dplyr)

# Set working directory to the location of the script.

mywd <- "C:/Martin/dataprocessing/R/Rrepo/data-parser"

# Store current working directory and restore setting when script is completed.

currentdir <- getwd()

if(!identical(mywd, currentdir)){
  # Set working directory
  setwd(mywd)
  cat("Working directory set to:", getwd(), "\n\n")
}


# Constants

parserVersion = "LachatDriftCorrection.R"
myFilters = Filters # Substitute .ps in original Filters array with .csv
myFilters[3,1] = "Excel csv files (*.csv)"
myFilters[3,2] = "*.csv"
rownames(myFilters)[3] = "csv"

# Set default data directory

defaultdir <- "L:/LACHAT/Spokas/*.csv"

# Choose data file from default directory or navigate to desired directory in the choose.files() dialog.

  cat("Imported ECD data from:\n\n")
  
  infile = choose.files(defaultdir, filters = myFilters[c("csv","All"),], caption = "Choose Lachat datafile")
  
  lachatdata = read.csv(infile, header = TRUE, as.is = TRUE, strip.white = TRUE, blank.lines.skip = TRUE)

df <- lachatdata %>%
        select(contains(-c("Units"))

  cat("Successfully read data from ", infile, "\n\n")

# Set .csv output filename by adding the prefix "LDC_"" to the input filename. 

# ************* Need to include the complete path in outfile
  outfile <- paste("LDC_", sequenceName[[1]][4], sep = "")



#  [1] "Sample.ID"             "Replicate.Number"      "Cup.Number"            "Detection.Date"        "Detection.Time"       
#  [6] "Auto.Dilution.Factor"  "Analyte.Name"          "Peak.Area"             "Peak.Height"           "Peak.Concentration"   
# [11] "Concentration.Units"   "Channel.Number"        "Analyte.Name.1"        "Peak.Area.1"           "Peak.Height.1"        
# [16] "Peak.Concentration.1"  "Concentration.Units.1" "Channel.Number.1"      "Analyte.Name.2"        "Peak.Area.2"          
# [21] "Peak.Height.2"         "Peak.Concentration.2"  "Concentration.Units.2" "Channel.Number.2"


analytes <- df %>%
              select(contains("Analyte")) %>%
              unique() %>%
              as.character()

# Rename columns to include analyte name

Area <- select(df, contains("Area"))
Height <- select(df, contains("Height"))
Channel <- select(df, contains("Channel"))
Concentration <- select(df, contains(c("Concentration", -"Units"))
Units <- select(df, contains("Units"))

names(Area) <- paste(analytes, "Area", sep = ".")
names(Height) <- paste(analytes, "Height", sep = ".")
names(Channel) <- paste(analytes, "Channel", sep = ".")
names(Concentration) <- paste(analytes, "Concentration", sep = ".")
names(Units) <- paste(analytes, "Units", sep = ".")

tidy <- cbind(Area, Height, Concentration, Units, Channel)



paste()
  

c(as.character(unique(select(lachatdata, contains("Analyte")))))


```

You can also embed plots, for example:

```{r, echo=FALSE}
plot(cars)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
