---
title: "Moisture Balance Convergence of nls()"
author: "mdusaire"
date: "April 27, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r libraries variables and functions, echo = FALSE}

# Load libraries

library(ggplot2)
library(tidyr)

# Clear all variables
# rm(list = ls())


# cat("\014")

setClass(Class="nlsfit",
         representation(
           fit="matrix",
           rsq="numeric",
           msg="character"
         )
)

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Constants and initial values
# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

modelResults <- NULL
parserID = "MB"
parserVersion = "18.05"
parserCounter <- 0
sumData <- NULL
logTime <- Sys.time()
todaysdate <- date()
modelAbbr <- c("Ex","HP", "Le", "Li", "Lo", "Loga", "MHP", "MP", "MPII", "Pa", "SF", "Tt", "WS")
modelParameterList <- c("a", "b", "c", "d", "e", "k", "ka", "kb", "kc", "kd", "ke", "n", "m", "p", "q", "D", "L", "V", "T")
modelEstimates <- data.frame(matrix(data = NA, nrow = 1, ncol = length(modelParameterList)))
colnames(modelEstimates) <- modelParameterList
modelPr.gt.ts <- modelEstimates
modelStdErrors <- modelEstimates
modeltValues <- modelEstimates
nModels = 13  # Plot and report model results from the top nModels based on cor(moisture, fit)
nModelResults = 13 

modelResultsList <- c("date", "time", "datafile", "sample", "dryingProfile", "finalTemp", "moisture", "modelAbbr", "modelName", "correlation",
                      modelParameterList,
                      paste("StdErr_", modelParameterList, sep = ""),
                      paste("tValue_", modelParameterList, sep = ""),
                      paste("Pr.gt.t_", modelParameterList, sep = ""),
                      "parserVersion", "fitError"
)

modelNames <- c("Exponential Fit", "Henderson Pabis Fit", "Lewis Fit", "Linear Fit", "Logarithmic Fit", "Logarithmic Fit (Yagcioglu et al. 1999)",
                "Modified Henderson Pabis Fit", "Modified Page Fit", "Modified Page II Fit", "Page Fit", "Simplified Fick Diffusion Fit",
                "Two-Term Fit (Henderson 1974)", "Wang and Singh Fit")
modelFormula <- c("log(moisture) ~ a * time + b", "moisture ~ a * exp(-k * time)", "moisture ~ exp(-k * time)", "moisture ~ a * time + b", "exp(moisture) ~ a * time + b",
                  "moisture ~ a * exp(-k * time) + c", "moisture ~ a * exp(-ka * time) + b * exp(-kb * time) + c * exp(-kc * time)", "moisture ~ exp(-(k * time) ^ n)",
                  "moisture ~ exp(-k * (time / L ^ 2) ^ n)", "moisture ~ exp(-k * time ^ n)", "moisture ~ a * exp((-c * time) / L ^ 2)",
                  "moisture ~ a * exp(-ka * time) + b * exp(-kb * time)", "moisture ~ 1 + a * time + b * time ^ 2")

# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Functions
# +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

decimalTime = function(time) {
  time = as.numeric(unlist(strsplit(time, ":")))
  time = time[1]*60+time[2]+time[3]/60
  return(time)
}

ModifiedPage_fit <- function(time, moisture) {
  tryResult <- tryCatch(nls(moisture ~ exp(-(k * time) ^ n), start = list(k = 0.5, n = 0.5)),
                        error=function(e) {
                          print(e)
                          print(strsplit(as.character(e), ":")[[1]][2])
                        }
  )
  if (class(tryResult) == "nls") {
    model <- nls(moisture ~ exp(-(k * time) ^ n), start = list(k = 0.5, n = 0.5))
    MP <- predict(model)
    t <- time
    rsq <- as.numeric(cor(moisture, MP))
    err <- NA
  } else {
    model <- NA
    t <- NA
    rsq <- NA
    err <- gsub("[\r\n]", "", tryResult)
  }
  return(list(model, t, rsq, err))
}

ModifiedPageII_fit <- function(time, moisture) {
  tryResult <- tryCatch(nls(moisture ~ exp(-(k * (time / L ^ 2) ^ n)), start = list(k = 0.5, L = 0.1, n = 0.5)),
                        error=function(e) {
                          print(e)
                          print(strsplit(as.character(e), ":")[[1]][2])
                        }
  )
  if (class(tryResult) == "nls") {
    model <- nls(moisture ~ exp(-(k * (time / L ^ 2) ^ n)), start = list(k = 0.5, L = 0.1, n = 0.5))
    MPII <- predict(model)
    t <- time
    rsq <- as.numeric(cor(moisture, MPII))
    err <- NA
  } else {
    model <- NA
    t <- NA
    rsq <- NA
    err <- gsub("[\r\n]", "", tryResult)
  }
  return(list(model, t, rsq, err))
}

```

```{r import sample data, echo = FALSE}
infile <- paste(getwd(), "/AC-122017.txt", sep = "")
MBData <- read.csv(infile, sep = "\t", header = FALSE, as.is = TRUE, strip.white = TRUE, blank.lines.skip = TRUE)

# There may still be other .txt files in the directory that do not contain Ohaus MB45 data.
# Look for specific text in line 2 of the .txt file.  Hopefully this elimiates non-data files.


testID <- grep("TEST ID", MBData[,], ignore.case = TRUE)  
switchOffMode <- grep("Switchoff Mode", MBData[,], ignore.case = TRUE)  
dryingProfile <- grep("Drying Profile", MBData[,], ignore.case = TRUE)  
dryingTemp <- grep("Drying Temp", MBData[,], ignore.case = TRUE)  
resultUnits <- grep("Result Units", MBData[,], ignore.case = TRUE)  
initialWeight <- grep("Initial Weight", MBData[,], ignore.case = TRUE)
finalWeight <- grep("Final Weight", MBData[,], ignore.case = TRUE)
elapsedTime <- grep("Elapsed Time", MBData[,], ignore.case = TRUE)  
finalPanTemp <- grep("Final Pan Temp", MBData[,], ignore.case = TRUE)  
finalResult <- grep("Final Result", MBData[,], ignore.case = TRUE)
endFlag <- grep("--End--", MBData[,], ignore.case = TRUE)  
nSamples <- length(endFlag)

# Remove duplicate Initial Weight values

initialWeight <- initialWeight[seq(1, by = 2, len = nSamples)]
beginData <- initialWeight + 1
endData <- elapsedTime - 1

for (i in 1:nSamples) {
  
  # Proceed with data processing if there are 2 or more data points
  
  predictDF <- NULL
  predictDFW <- NULL
  predictNext <- NULL
  corr <- NULL
  
  #   Extract parameter info
  
  testID[i] <- gsub("\\s+", "", strsplit(MBData[testID[i],], ":")[[1]][2])
  switchOffMode[i] <- gsub("\\s+", "", strsplit(MBData[switchOffMode[i],], "Mode.")[[1]][2])
  dryingProfile[i] <- gsub("\\s+", "", strsplit(MBData[dryingProfile[i],], "Profile.")[[1]][2])  
  dryingTemp[i] <- gsub("\\s+", "", strsplit(MBData[dryingTemp[i],], "Temp.")[[1]][2])
  resultUnits[i] <- gsub("\\s+", "", strsplit(MBData[resultUnits[i],], "Units.")[[1]][2])
  
  initialWeight[i] <- gsub("\\s+", "", strsplit(MBData[initialWeight[i],], "Weight.")[[1]][2])
  elapsedTime[i] <- gsub("\\s+", "", strsplit(MBData[elapsedTime[i],], "Time.")[[1]][2])
  finalWeight[i] <- gsub("\\s+", "", strsplit(MBData[finalWeight[i],], "Weight.")[[1]][2])
  
  initialWeight[i] <- gsub("[^0-9\\.]", "", initialWeight[i])
  finalWeight[i] <- gsub("[^0-9\\.]", "", finalWeight[i])
  finalPanTemp[i] <- gsub("\\s+", "", strsplit(MBData[finalPanTemp[i],], "Temp.")[[1]][2])
  finalPanTemp[i] <- gsub("[^0-9\\.]", "", finalPanTemp[i])
  finalResult[i] <- gsub("\\s+", "", strsplit(MBData[finalResult[i],], "Result.")[[1]][2])
  finalResult[i] <- gsub("[^0-9\\.]", "", finalResult[i])
  
  rawData <- MBData[beginData[i]:endData[i],]
  rawData <- gsub("[^0-9\\.\\:]", " ", rawData)
  rawData <- gsub("\\s+", ",", rawData)
  rawData <- paste(rawData, i)
  rawData <- read.table(text = rawData, sep = ",", header = FALSE,
                        col.names = c('time', 'temperature', 'moisture', 'sample'),
                        as.is = TRUE)
  
  finalTemp <- as.numeric(finalPanTemp[i])
  moisture <- as.numeric(finalResult[i])
  
  
  # Convert time from character string to time element.  This will append the current date to the date-time element.
  # The time may need to be converted to decimal time depending on how the fitting method represents time.
  
  # rawData$time <- as.POSIXct(rawData$time,format="%H:%M:%S")
  
  dectime = sapply(rawData$time,decimalTime)
  
  # Calculate moisture ratio MR, and include in rawData
  
  MR <- round(1 - rawData$moisture / max(rawData$moisture, na.rm = TRUE), 3)
  
  # Calculate masses based on initialWeight(s)
  
  mass <- as.numeric(initialWeight[i]) - as.numeric(initialWeight[i]) * rawData$moisture / 100
  
  # Include mass in rawData
  
  rawData <- cbind(rawData[, 1:3], dectime, mass, MR, rawData[, 4])
  
  # For some reason this process removes the name from the sample columm.  Re-assign column names.
  
  names(rawData) <-  c('time', 'temperature', 'moisture', 'dectime', 'mass', 'MR', 'sample')
}

```

### Here's the name of the data file and what it looks like:
##### [Hopefully if the datafile and the .Rmd are in the same directory this will run correctly.]

```{r data info}
print(infile)

head(rawData[, c("dectime", "MR")])
```

### Modified Page Model fit using nls():

```{r Modified Page}

moisture <- rawData$MR
time <- rawData$dectime

nls(moisture ~ exp(-(k * time) ^ n), start = list(k = 0.5, n = 0.5))

```


### Calculate model predicted values by substituting fit parameters into model equation.  Could also have used predict(). Plot data and model fit:

```{r Manual fit MP}

MP_moisture <- exp(-(1.185 * time) ^ 1.278)

cor(MP_moisture, moisture)

plotData <- data.frame(time, moisture, MP_moisture)

head(plotData)

ggplot(plotData, aes(x = time, y = moisture)) +
  geom_point(size = 2) +
  geom_line(data=plotData, aes(x = time, y = MP_moisture), color = 'darkgreen', size = 1.5)

```

### Modified Page II fit using nls() throws a convergence error.

```{r Modified Page II}

moisture <- rawData$MR
time <- rawData$dectime

head(rawData[, c("dectime", "MR")])

  tryResult <- tryCatch(nls(moisture ~ exp(-(k * (time / L ^ 2) ^ n)),
                            start = list(k = 0.5, L = 0.1, n = 0.5)),
                        error=function(e) {
                          print(e)
                          print(strsplit(as.character(e), ":")[[1]][2])
                        }
  )

```

### Using MoistureBalanceInteractive, I determined that a good fit is possible with the parameters listed below:

```{r Manual fit MPII}

k = 0.14
L = 0.43
n = 1.29

MPII_moisture <- exp(-(k * (time / L ^ 2) ^ n))

cor(MPII_moisture, moisture)

plotData <- data.frame(time, moisture, MPII_moisture)

head(plotData)
```

### The model fit looks pretty good:

```{r Manual fit MPII plot}

ggplot(plotData, aes(x = time, y = moisture)) +
  geom_point(size = 2) +
  geom_line(data=plotData, aes(x = time, y = MPII_moisture), color = 'orange', size = 1.5)
```

### Even with starting values given above, nls() still doesn't converge.

```{r Modified Page II should work}

  tryResult <- tryCatch(nls(moisture ~ exp(-(k * (time / L ^ 2) ^ n)),
                            start = list(k = 0.14, L = 0.43, n = 1.29)),
                        error=function(e) {
                          print(e)
                          print(strsplit(as.character(e), ":")[[1]][2])
                        }
  )

```

### Modified Page seems to work...

```{r Modified Page should work}

nls(moisture ~ exp(-(k * time) ^ n), start = list(k = 1.185, n = 1.278))

```

### What am I missing?

### What about a subsample of the data

```{r subsample}

subData <- rawData[sort(sample(1:nrow(rawData), 20, replace = FALSE)),]

moisture <- subData$MR
time <- subData$dectime

head(rawData[, c("dectime", "MR")])

  tryResult <- tryCatch(nls(moisture ~ exp(-(k * (time / L ^ 2) ^ n)),
                            start = list(k = 0.14, L = 0.43, n = 1.29)),
                        error=function(e) {
                          print(e)
                          print(strsplit(as.character(e), ":")[[1]][2])
                        }
  )

plotData <- data.frame(time, moisture)

ggplot(plotData, aes(x = time, y = moisture)) +
  geom_point(size = 2)

```
